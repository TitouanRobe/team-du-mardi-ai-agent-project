<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>TravelAgent.ai - Votre ItinÃ©raire</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/chat.css">
</head>

<body>
    <header>
        <div class="header-left">
            <a href="/"><img src="/static/images/Logo.png" alt="Logo Travel Agent" class="logo"></a>
            <nav>
                <a href="#">Explorer</a>
                <a href="#">Comment Ã§a marche ?</a>
            </nav>
        </div>

        <div class="header-right">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                <path
                    d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM320 240C302.3 240 288 254.3 288 272C288 285.3 277.3 296 264 296C250.7 296 240 285.3 240 272C240 227.8 275.8 192 320 192C364.2 192 400 227.8 400 272C400 319.2 364 339.2 344 346.5L344 350.3C344 363.6 333.3 374.3 320 374.3C306.7 374.3 296 363.6 296 350.3L296 342.2C296 321.7 310.8 307 326.1 302C332.5 299.9 339.3 296.5 344.3 291.7C348.6 287.5 352 281.7 352 272.1C352 254.4 337.7 240.1 320 240.1zM288 432C288 414.3 302.3 400 320 400C337.7 400 352 414.3 352 432C352 449.7 337.7 464 320 464C302.3 464 288 449.7 288 432z" />
            </svg>
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                <path
                    d="M320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576C388.8 576 451.3 548.8 497.3 504.6C504.6 497.6 506.7 486.7 502.6 477.5C498.5 468.3 488.9 462.6 478.8 463.4C473.9 463.8 469 464 464 464C362.4 464 280 381.6 280 280C280 207.9 321.5 145.4 382.1 115.2C391.2 110.7 396.4 100.9 395.2 90.8C394 80.7 386.6 72.5 376.7 70.3C358.4 66.2 339.4 64 320 64z" />
            </svg>
        </div>
    </header>

    <div class="results-container">
        <h2>Votre itinÃ©raire pour {{ destination or origin }}</h2>

        <div class="tabs-header">
            <button id="tab-flights" class="tab-btn active" onclick="openTab(event, 'vols')">âœˆï¸ Vols ({{ flights|length
                }})</button>
            <button id="tab-hotels" class="tab-btn" onclick="openTab(event, 'hotels')">ğŸ¨ HÃ´tels ({{ hotels|length
                }})</button>
            <button id="tab-activities" class="tab-btn" onclick="openTab(event, 'activites')">ğŸ›ï¸ ActivitÃ©s ({{
                activities|length }})</button>
        </div>

        <!-- â•â•â•â•â•â•â• ONGLET VOLS â•â•â•â•â•â•â• -->
        <div id="vols" class="tab-content active">
            {% if flights %}
            {% for flight in flights %}
            <div class="result-card flight-card">
                <div class="card-info">
                    <strong>{{ flight.airline }}</strong>
                    {% if flight.origin and flight.destination %}
                    <p>ğŸ›« {{ flight.origin }} â†’ {{ flight.destination }}</p>
                    {% endif %}
                    <p>ğŸ•’ DÃ©part : {{ flight.departure }}</p>
                    {% if flight.arrival %}
                    <p>ğŸ• ArrivÃ©e : {{ flight.arrival }}</p>
                    {% endif %}
                </div>
                <div class="card-price">{{ flight.price }}â‚¬</div>
            </div>
            {% endfor %}
            {% else %}
            <p class="empty-msg">Aucun vol trouvÃ©.</p>
            {% endif %}
        </div>

        <!-- â•â•â•â•â•â•â• ONGLET HOTELS â•â•â•â•â•â•â• -->
        <div id="hotels" class="tab-content">
            {% if hotels %}
            {% for hotel in hotels %}
            <div class="result-card hotel-card">
                <div class="card-info">
                    <strong>{{ hotel.name }}</strong>
                    {% if hotel.city %}
                    <p>ğŸ“ {{ hotel.city }}</p>
                    {% endif %}
                    {% if hotel.amenities %}
                    <p>ğŸ›ï¸ {{ hotel.amenities }}</p>
                    {% endif %}
                    {% if hotel.available_start and hotel.available_end %}
                    <p>ğŸ“… Disponible du {{ hotel.available_start }} au {{ hotel.available_end }}</p>
                    {% endif %}
                </div>
                <div class="card-price">{{ hotel.price }}â‚¬/nuit</div>
            </div>
            {% endfor %}
            {% else %}
            <p class="empty-msg">Aucun hÃ´tel trouvÃ©.</p>
            {% endif %}
        </div>

        <!-- â•â•â•â•â•â•â• ONGLET ACTIVITES â•â•â•â•â•â•â• -->
        <div id="activites" class="tab-content">
            {% if activities %}
            {% for act in activities %}
            <div class="result-card activity-card">
                <div class="card-tag">{{ act.type }}</div>
                <div class="card-info">
                    <strong>{{ act.name }}</strong>
                    {% if act.description %}
                    <p>{{ act.description }}</p>
                    {% endif %}
                </div>
                <div class="card-price">{{ act.price }}â‚¬</div>
            </div>
            {% endfor %}
            {% else %}
            <p class="empty-msg">Aucune activitÃ© ou restaurant trouvÃ©.</p>
            {% endif %}
        </div>
    </div>

    <!-- Widget de Chat Flottant -->
    <div id="chat-widget">
        <div id="chat-header" onclick="toggleChat()">
            <h3>ğŸ’¬ Affiner ma recherche</h3>
            <button id="chat-toggle">âˆ’</button>
        </div>
        <div id="chat-messages">
            <div class="chat-message agent">
                <div class="chat-avatar">ğŸ¤–</div>
                <div class="chat-bubble">
                    Bonjour ! Besoin d'affiner vos rÃ©sultats ?<br>
                    Exemples : "seulement vegan", "moins de 150â‚¬", "hÃ´tels avec piscine"
                </div>
            </div>
        </div>
        <div id="chat-input-container">
            <input type="text" id="chat-input" placeholder="Ex: seulement des restaurants vegan">
            <button id="chat-send" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script>
        // Variables globales
        const origin = "{{ origin or '' }}";
        const destination = "{{ destination or '' }}";
        let chatHistory = [];

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // === CHAT FONCTIONS ===

        function toggleChat() {
            const widget = document.getElementById('chat-widget');
            const toggle = document.getElementById('chat-toggle');
            widget.classList.toggle('minimized');
            toggle.textContent = widget.classList.contains('minimized') ? '+' : 'âˆ’';
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            // Ajouter message utilisateur
            appendMessage('user', message);
            chatHistory.push({ role: 'user', content: message });
            input.value = '';

            // DÃ©sactiver l'input pendant le traitement
            input.disabled = true;
            document.getElementById('chat-send').disabled = true;

            // Afficher l'indicateur de chargement
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message agent';
            loadingDiv.id = 'chat-loading-msg';
            loadingDiv.innerHTML = `
                <div class="chat-avatar">ğŸ¤–</div>
                <div class="chat-loading"><span></span><span></span><span></span></div>
            `;
            document.getElementById('chat-messages').appendChild(loadingDiv);
            scrollToBottom();

            // Appeler le backend pour raffinement
            const eventSource = new EventSource(`/chat_refine?message=${encodeURIComponent(message)}&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`);

            let agentMessage = '';
            let isFinished = false;

            eventSource.onmessage = function (event) {
                if (isFinished) return;

                try {
                    const data = JSON.parse(event.data);
                    console.log('Event received:', data.type, data);

                    if (data.type === 'log' || data.type === 'tool') {
                        // Optionnel : afficher les logs dans le chat
                        console.log('Agent log:', data.message);
                    } else if (data.type === 'response') {
                        agentMessage = data.message;
                    } else if (data.type === 'results') {
                        console.log("Mise a jour des resultats...", data);
                        // Ne mettre Ã  jour que les catÃ©gories prÃ©sentes dans le payload
                        if (data.flights !== undefined) {
                            updateFlights(data.flights);
                        }
                        if (data.activities !== undefined) {
                            updateActivities(data.activities);
                        }
                        if (data.hotels !== undefined) {
                            updateHotels(data.hotels);
                        }
                    } else if (data.type === 'complete') {
                        isFinished = true;
                        const loader = document.getElementById('chat-loading-msg');
                        if (loader) loader.remove();

                        appendMessage('agent', agentMessage || data.message || "C'est fait !");
                        chatHistory.push({ role: 'agent', content: agentMessage || data.message });

                        input.disabled = false;
                        document.getElementById('chat-send').disabled = false;
                        input.focus();

                        eventSource.close();
                    }
                } catch (err) {
                    console.error('Erreur parsing SSE:', err);
                }
            };

            eventSource.onerror = function (err) {
                if (isFinished) return;

                if (eventSource.readyState === EventSource.CLOSED) {
                    return;
                }

                console.error('EventSource error:', err);
                const loader = document.getElementById('chat-loading-msg');
                if (loader) loader.remove();

                if (!agentMessage) {
                    appendMessage('agent', "Oups, petit probleme de connexion. Reessayez !");
                } else {
                    appendMessage('agent', agentMessage);
                }

                input.disabled = false;
                document.getElementById('chat-send').disabled = false;
                eventSource.close();
            };
        }

        function appendMessage(role, text) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-bubble">${text}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateFlights(flights) {
            if (!flights || flights.length === 0) {
                console.log("Aucun vol Ã  mettre Ã  jour");
                return;
            }

            console.log("Mise Ã  jour des vols:", flights.length);
            updateTab('vols', flights, (flight) => `
                <div class="result-card flight-card">
                    <div class="card-info">
                        <strong>${flight.airline || 'Vol'}</strong>
                        ${flight.origin && flight.destination ? `<p>ğŸ›« ${flight.origin} â†’ ${flight.destination}</p>` : ''}
                        <p>ğŸ•’ DÃ©part : ${flight.departure || 'N/A'}</p>
                        ${flight.arrival ? `<p>ğŸ• ArrivÃ©e : ${flight.arrival}</p>` : ''}
                    </div>
                    <div class="card-price">${flight.price}â‚¬</div>
                </div>
            `);
            const tabFlights = document.getElementById('tab-flights');
            if (tabFlights) tabFlights.innerText = `âœˆï¸ Vols (${flights.length})`;
        }

        function updateHotels(hotels) {
            if (!hotels || hotels.length === 0) {
                console.log("Aucun hÃ´tel Ã  mettre Ã  jour");
                return;
            }

            console.log("Mise Ã  jour des hÃ´tels:", hotels.length);
            updateTab('hotels', hotels, (hotel) => `
                <div class="result-card hotel-card">
                    <div class="card-info">
                        <strong>${hotel.name}</strong>
                        ${hotel.city ? `<p>ğŸ“ ${hotel.city}</p>` : ''}
                        ${hotel.amenities ? `<p>ğŸ›ï¸ ${hotel.amenities}</p>` : ''}
                        ${hotel.available_start && hotel.available_end ? `<p>ğŸ“… Disponible du ${hotel.available_start} au ${hotel.available_end}</p>` : ''}
                    </div>
                    <div class="card-price">${hotel.price}â‚¬/nuit</div>
                </div>
            `);
            const tabHotels = document.getElementById('tab-hotels');
            if (tabHotels) tabHotels.innerText = `ğŸ¨ HÃ´tels (${hotels.length})`;
        }

        function updateActivities(activities) {
            if (!activities || activities.length === 0) {
                console.log("Aucune activitÃ© Ã  mettre Ã  jour");
                return;
            }

            console.log("Mise Ã  jour des activitÃ©s:", activities.length);
            updateTab('activites', activities, (act) => `
                <div class="result-card activity-card">
                    <div class="card-tag">${act.type || 'ActivitÃ©'}</div>
                    <div class="card-info">
                        <strong>${act.name}</strong>
                        ${act.description ? `<p>${act.description}</p>` : ''}
                    </div>
                    <div class="card-price">${act.price}â‚¬</div>
                </div>
            `);
            const tabActivities = document.getElementById('tab-activities');
            if (tabActivities) tabActivities.innerText = `ğŸ›ï¸ ActivitÃ©s (${activities.length})`;
        }

        function updateTab(tabId, items, renderFunc) {
            const tab = document.getElementById(tabId);
            if (!tab) {
                console.error(`Tab ${tabId} introuvable !`);
                return;
            }

            if (!items || items.length === 0) {
                tab.innerHTML = '<p class="empty-msg">Aucun rÃ©sultat trouvÃ©.</p>';
            } else {
                tab.innerHTML = items.map(renderFunc).join('');
            }

            console.log(`Onglet ${tabId} mis a jour avec ${items ? items.length : 0} elements`);
        }

        // Permettre l'envoi avec EntrÃ©e
        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>

</html>