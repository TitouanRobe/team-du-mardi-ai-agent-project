<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>TravelAgent.ai - Votre ItinÃ©raire</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/chat.css">
</head>

<body>
    <header>
        <div class="header-left">
            <img src="/static/images/Logo.png" alt="Logo Travel Agent" class="logo">
            <nav>
                <a href="#">Explorer</a>
                <a href="#">Comment Ã§a marche ?</a>
            </nav>
        </div>

        <div class="header-right">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                <path
                    d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM320 240C302.3 240 288 254.3 288 272C288 285.3 277.3 296 264 296C250.7 296 240 285.3 240 272C240 227.8 275.8 192 320 192C364.2 192 400 227.8 400 272C400 319.2 364 339.2 344 346.5L344 350.3C344 363.6 333.3 374.3 320 374.3C306.7 374.3 296 363.6 296 350.3L296 342.2C296 321.7 310.8 307 326.1 302C332.5 299.9 339.3 296.5 344.3 291.7C348.6 287.5 352 281.7 352 272.1C352 254.4 337.7 240.1 320 240.1zM288 432C288 414.3 302.3 400 320 400C337.7 400 352 414.3 352 432C352 449.7 337.7 464 320 464C302.3 464 288 449.7 288 432z" />
            </svg>
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                <path
                    d="M320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576C388.8 576 451.3 548.8 497.3 504.6C504.6 497.6 506.7 486.7 502.6 477.5C498.5 468.3 488.9 462.6 478.8 463.4C473.9 463.8 469 464 464 464C362.4 464 280 381.6 280 280C280 207.9 321.5 145.4 382.1 115.2C391.2 110.7 396.4 100.9 395.2 90.8C394 80.7 386.6 72.5 376.7 70.3C358.4 66.2 339.4 64 320 64z" />
            </svg>
        </div>
    </header>

    <div class="results-container">
        <h2>Votre itinÃ©raire pour {{ destination or origin }}</h2>

        <div class="tabs-header">
            <button class="tab-btn active" onclick="openTab(event, 'vols')">âœˆï¸ Vols ({{ flights|length }})</button>
            <button class="tab-btn" onclick="openTab(event, 'hotels')">ğŸ¨ HÃ´tels ({{ hotels|length }})</button>
            <button class="tab-btn" onclick="openTab(event, 'activites')">ğŸ›ï¸ ActivitÃ©s ({{ activities|length
                }})</button>
        </div>

        <div id="vols" class="tab-content active">
            {% if flights %}
            {% for flight in flights %}
            <div class="result-card flight-card">
                <div class="card-info">
                    <strong>{{ flight.airline }}</strong>
                    <p>ğŸ•’ DÃ©part : {{ flight.departure }}</p>
                </div>
                <div class="card-price">{{ flight.price }}â‚¬</div>
            </div>
            {% endfor %}
            {% else %}
            <p class="empty-msg">Aucun vol trouvÃ©.</p>
            {% endif %}
        </div>

        <div id="hotels" class="tab-content">
            {% if hotels %}
            {% for hotel in hotels %}
            <div class="result-card hotel-card">
                <div class="card-info">
                    <strong>{{ hotel.name }}</strong>
                    <p>ğŸ“ {{ hotel.city }}</p>
                    <p>ğŸ›ï¸ {{ hotel.amenities }}</p>
                    <p>ğŸ“… Disponible du {{ hotel.available_start }} au {{ hotel.available_end }}</p>
                </div>
                <div class="card-price">{{ hotel.price }}â‚¬/nuit</div>
            </div>
            {% endfor %}
            {% else %}
            <p class="empty-msg">Aucun hÃ´tel trouvÃ©.</p>
            {% endif %}
        </div>

        <div id="activites" class="tab-content">
            {% if activities %}
            {% for act in activities %}
            <div class="result-card activity-card">
                <div class="card-tag">{{ act.type }}</div>
                <div class="card-info">
                    <strong>{{ act.name }}</strong>
                    <p>{{ act.description }}</p>
                </div>
                <div class="card-price">{{ act.price }}â‚¬</div>
            </div>
            {% endfor %}
            {% else %}
            <p class="empty-msg">Aucune activitÃ© ou restaurant trouvÃ©.</p>
            {% endif %}
        </div>
    </div>

    <!-- Widget de Chat Flottant -->
    <div id="chat-widget">
        <div id="chat-header" onclick="toggleChat()">
            <h3>ğŸ’¬ Affiner ma recherche</h3>
            <button id="chat-toggle">âˆ’</button>
        </div>
        <div id="chat-messages">
            <div class="chat-message agent">
                <div class="chat-avatar">ğŸ¤–</div>
                <div class="chat-bubble">
                    Bonjour ! Besoin d'affiner vos rÃ©sultats ?<br>
                    Exemples : "seulement vegan", "moins de 150â‚¬", "hÃ´tels avec piscine"
                </div>
            </div>
        </div>
        <div id="chat-input-container">
            <input type="text" id="chat-input" placeholder="Ex: seulement des restaurants vegan">
            <button id="chat-send" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script>
        // Variables globales
        const origin = "{{ origin or '' }}";
        const destination = "{{ destination or '' }}";
        let chatHistory = [];

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // === CHAT FONCTIONS ===

        function toggleChat() {
            const widget = document.getElementById('chat-widget');
            const toggle = document.getElementById('chat-toggle');
            widget.classList.toggle('minimized');
            toggle.textContent = widget.classList.contains('minimized') ? '+' : 'âˆ’';
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            // Ajouter message utilisateur
            appendMessage('user', message);
            chatHistory.push({ role: 'user', content: message });
            input.value = '';

            // DÃ©sactiver l'input pendant le traitement
            input.disabled = true;
            document.getElementById('chat-send').disabled = true;

            // Afficher l'indicateur de chargement
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message agent';
            loadingDiv.innerHTML = `
                <div class="chat-avatar">ğŸ¤–</div>
                <div class="chat-loading"><span></span><span></span><span></span></div>
            `;
            document.getElementById('chat-messages').appendChild(loadingDiv);
            scrollToBottom();

            // Appeler le backend pour raffinement
            const eventSource = new EventSource(`/chat_refine?message=${encodeURIComponent(message)}&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`);

            let agentMessage = '';

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'response') {
                    agentMessage = data.message;
                } else if (data.type === 'results') {
                    // Mettre Ã  jour les onglets
                    updateResults(data.flights, data.activities, data.hotels);
                } else if (data.type === 'complete') {
                    // Retirer le loading et afficher la rÃ©ponse
                    loadingDiv.remove();
                    appendMessage('agent', agentMessage || data.message);
                    chatHistory.push({ role: 'agent', content: agentMessage || data.message });

                    // RÃ©activer l'input
                    input.disabled = false;
                    document.getElementById('chat-send').disabled = false;
                    input.focus();

                    eventSource.close();
                }
            };

            eventSource.onerror = function () {
                loadingDiv.remove();
                appendMessage('agent', "DÃ©solÃ©, une erreur s'est produite. RÃ©essayez.");
                input.disabled = false;
                document.getElementById('chat-send').disabled = false;
                eventSource.close();
            };
        }

        function appendMessage(role, text) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-bubble">${text}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateResults(flights, activities, hotels) {
            // Mettre Ã  jour l'onglet Vols
            updateTab('vols', flights, (flight) => `
                <div class="result-card flight-card">
                    <div class="card-info">
                        <strong>${flight.airline}</strong>
                        <p>ğŸ•’ DÃ©part : ${flight.departure}</p>
                    </div>
                    <div class="card-price">${flight.price}â‚¬</div>
                </div>
            `);

            // Mettre Ã  jour l'onglet HÃ´tels
            updateTab('hotels', hotels, (hotel) => `
                <div class="result-card hotel-card">
                    <div class="card-info">
                        <strong>${hotel.name}</strong>
                        <p>ğŸ“ ${hotel.city || ''}</p>
                        <p>ğŸ›ï¸ ${hotel.amenities || ''}</p>
                    </div>
                    <div class="card-price">${hotel.price}â‚¬/nuit</div>
                </div>
            `);

            // Mettre Ã  jour l'onglet ActivitÃ©s
            updateTab('activites', activities, (act) => `
                <div class="result-card activity-card">
                    <div class="card-tag">${act.type}</div>
                    <div class="card-info">
                        <strong>${act.name}</strong>
                        <p>${act.description}</p>
                    </div>
                    <div class="card-price">${act.price}â‚¬</div>
                </div>
            `);

            // Mettre Ã  jour les compteurs dans les onglets
            document.querySelector('.tab-btn:nth-child(1)').textContent = `âœˆï¸ Vols (${flights.length})`;
            document.querySelector('.tab-btn:nth-child(2)').textContent = `ğŸ¨ HÃ´tels (${hotels.length})`;
            document.querySelector('.tab-btn:nth-child(3)').textContent = `ğŸ›ï¸ ActivitÃ©s (${activities.length})`;
        }

        function updateTab(tabId, items, renderFunc) {
            const tab = document.getElementById(tabId);
            if (items.length === 0) {
                tab.innerHTML = '<p class="empty-msg">Aucun rÃ©sultat trouvÃ©.</p>';
            } else {
                tab.innerHTML = items.map(renderFunc).join('');
            }
        }

        // Permettre l'envoi avec EntrÃ©e
        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>

</html>